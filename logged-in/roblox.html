<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Roblox (now.gg Copy)</title>
    
    <!-- VERN Proxy Scripts (Injected) -->
    <script src="/logged-in/uv/uv.bundle.js"></script>
    <script src="/logged-in/uv/uv.client.js"></script>
    <script src="/logged-in/uv/uv.config.js"></script>
    <script src="/logged-in/baremux/index.js"></script>
    <script>
        // Global asset loader
        async function loadGameAssets() {
            console.log("Service Worker Active. Loading assets...");
            
            const head = document.head;
            const body = document.body;

            // CSS
            const cssUrls = [
                'https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap',
                'https://cdn.now.gg/nowgg-static/fonts/fonts.css',
                'https://now.gg/3/play/assets/_next/static/css/styles.d6c7be162965db05.css'
            ];
            
            cssUrls.forEach(url => {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = getProxiedUrl(url);
                head.appendChild(link);
            });

            // Images/Video content injection
            const logo = document.querySelector('.app-logo');
            if(logo) {
                logo.innerHTML = `<img width="120" height="30" src="${getProxiedUrl('https://now.gg/3/_next/static/media/nowgg-logo.2eda3eaf.svg')}" alt="now.gg Logo"/>`;
            }

            const video = document.getElementById('bg-video');
            if(video) {
                video.poster = getProxiedUrl('https://cdn.now.gg/apps-content/default/images/Banner_Landscape.jpg');
                video.innerHTML = `<source type="video/mp4" src="${getProxiedUrl('https://cdn.now.gg/apps-content/default/launch-video/desktop/Launch_1920.mp4')}"/>`;
                video.load(); // Reload video source
            }

            // External Scripts
            const scripts = [
                'https://now.gg/3/play/assets/_next/static/chunks/polyfills-42372ed130431b0a.js',
                'https://now.gg/3/play/assets/_next/static/chunks/webpack-fcb1a2d5c6cf741a.js',
                'https://now.gg/3/play/assets/_next/static/chunks/main-4f884091f83cebb1.js',
                'https://now.gg/3/play/assets/_next/static/chunks/pages/_app-35838c1c35badd69.js',
                'https://now.gg/3/play/assets/_next/static/chunks/pages/apps/%5B...index%5D-927b8564ac4c49eb.js'
            ];

            for (const src of scripts) {
                const s = document.createElement('script');
                s.src = getProxiedUrl(src);
                s.defer = true;
                body.appendChild(s);
            }
        }

        (async () => {
            // SW Registration
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/logged-in/sw.js', { scope: '/logged-in/' });
                    console.log("VERN SW Registered");
                    
                    if (navigator.serviceWorker.controller) {
                        // SW is already active, safe to load
                        loadGameAssets();
                    } else {
                        // Wait for activation then reload/load
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            console.log("SW activated, reloading...");
                            window.location.reload();
                        });
                    }
                } catch(e) { console.error("SW Init Error:", e); }
            } else {
                // Fallback for no SW support (unlikely to work but tries)
                loadGameAssets();
            }

            // BareMux Init
            try {
                const conn = new BareMux.BareMuxConnection(window.location.origin + '/logged-in/baremux/worker.js');
                await conn.setTransport('/logged-in/libcurl/index.mjs', [
                    { websocket: 'wss://wisp.mercury.moe/' },
                    { websocket: 'wss://wisp.mercurywork.shop/' }
                ]);
                console.log("BareMux Transport Set");
            } catch(e) { console.error("BareMux Init Error:", e); }
        })();

        // --- URL REWRITING FOR PROXY ---
        function getProxiedUrl(url) {
            if (!url || !url.startsWith('http')) return url;
            // Ensure config exists or fallback
            if (!self.__uv$config) return url; 
            
            const prefix = (window.location.origin + self.__uv$config.prefix);
            return prefix + Ultraviolet.codec.xor.encode(url);
        }
    </script>

    <script>
        try {
            history.replaceState = function(state, title, url) { console.log("Blocked URL update:", url); };
            history.pushState = function(state, title, url) { console.log("Blocked URL push:", url); };
        } catch (e) { console.warn("Shim failed:", e); }
    </script>

    <script>
        // This mimics the original site's ID generation so the game connects
        (function() {
            // Simple random ID generator
            const generateId = (prefix) => prefix + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            
            // 1. Generate User Agent ID if missing
            if (!localStorage.getItem("fe_uaId")) {
                localStorage.setItem("fe_uaId", generateId("ua-"));
            }
            
            // 2. Generate Session ID
            sessionStorage.setItem("fe_uaSessionId", generateId("uasess-"));
            
            // 3. Generate Visit ID
            if (!sessionStorage.getItem("ngVisitId")) {
                sessionStorage.setItem("ngVisitId", generateId("visitid-"));
            }
            
            console.log("Fake Session IDs generated:", sessionStorage.getItem("fe_uaSessionId"));
        })();
    </script>
    
    <!-- Proxying External Stylesheets (Handled by loadGameAssets) -->

    <style>
        body { background-color: #111; margin: 0; overflow: hidden; }
        .AppContent { height: 100vh; width: 100vw; }
        .HeroAppInfo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; }
    </style>
</head>
<body>

    <div id="__next">
        <div class="lcpImgWrapper full-wh" style="background-color: #222;"></div>

        <section class="StyledLayout">
            <header class="sc-74ddd4db-0 gLZcnl">
                <div class="sc-b5bac989-0 ifdeIN app-logo">
                    <!-- Proxy Image (Injected) -->
                </div>
            </header>

            <div class="AppContent">
                <section class="sc-31f7ab6d-0 jMlUSs auto-h">
                    <section class="sc-31f7ab6d-1 TUWaW">
                        <div class="StyledPreview">
                            <video class="BgVideo" autoplay muted loop playsinline height="100%" width="100%" id="bg-video">
                                <!-- Sources injected via JS -->
                            </video>
                        </div>

                        <div class="HeroAppInfo landscape">
                            <h1 style="color: white; font-family: 'Bricolage Grotesque'; font-size: 48px; margin-bottom: 20px;">Roblox</h1>
                            <div class="PlayBtnWrap">
                                <button class="Button loading" id="ng-getting-ready-btn" style="background: #FF42A5; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 18px; cursor: pointer;">
                                    Getting ready...
                                </button>
                            </div>
                            <div class="sc-7f59e304-20 dSWedn">
                                <p style="color: rgba(255,255,255,0.7);">Preparing to launch</p>
                            </div>
                        </div>
                    </section>
                </section>
            </div>
        </section>
    </div>

    <script id="__NEXT_DATA__" type="application/json">
    {
        "props": {
            "pageProps": {
                "appInfo": {
                    "status": "Success",
                    "appId": "19900",
                    "appName": "Roblox",
                    "packageName": "com.roblox.client",
                    "appType": "Android",
                    "playDomain": "now.gg",
                    "authClientId": "zBC1LCs7s7IuZzxQP9oO$$01FM9VYWMSWR6SP42Q4S46Z0SY",
                    "playFeFeatures": { "enableAiBot": true, "enableRecording": true }
                },
                "popularGames": [], "sidebarGames": [], "ssrGames": { "topBarApps": [], "topApps": [] }
            },
            "__N_SSP": true
        },
        "page": "/apps/[...index]",
        "query": { "index": ["a", "19900", "b.html"] },
        "buildId": "uSxdBU4_Ag5Vf23kJZUCZ",
        "assetPrefix": "https://now.gg/3/play/assets",
        "runtimeConfig": { "NEXT_PUBLIC_ENVIRONMENT": "prod3-berlin", "NEXT_PUBLIC_FE_VERSION": "berlin-v1.49.100-arm.1" },
        "isFallback": false, "gssp": true
    }
    </script>

</body>
</html>