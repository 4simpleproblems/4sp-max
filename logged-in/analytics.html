<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - ANALYTICS</title>
    <meta name="description" content="Admin analytics dashboard for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <style>
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #040404; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .user-table, .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .user-table th, .user-table td, .analytics-table th, .analytics-table td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #1a1a1a;
            vertical-align: middle;
        }
        .user-table th, .analytics-table th {
            color: #707070;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .user-table tr:hover, .analytics-table tr:hover {
            background-color: #0d0d0d;
        }

        .provider-icon {
            width: 1.25rem; height: 1.25rem; object-fit: contain;
        }

        .action-btn {
            padding: 0.35rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            margin-right: 0.5rem;
            border: 1px solid transparent;
        }
        .btn-block { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2); }
        .btn-unblock { background-color: rgba(34, 197, 94, 0.1); color: #22c55e; border-color: rgba(34, 197, 94, 0.2); }
        .btn-admin { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: rgba(59, 130, 246, 0.2); }
        .btn-remove-admin { background-color: rgba(234, 179, 8, 0.1); color: #eab308; border-color: rgba(234, 179, 8, 0.2); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: #0d0d0d; border: 1px solid #333; padding: 2rem;
            border-radius: 1rem; max-width: 500px; width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .chart-container {
            background-color: #0d0d0d; border: 1px solid #1a1a1a;
            border-radius: 0.75rem; padding: 1rem; height: 320px;
        }
        
        .preset-chip {
            display: inline-block; padding: 0.25rem 0.75rem; background: #1a1a1a;
            border: 1px solid #333; border-radius: 1rem; color: #9ca3af;
            font-size: 0.75rem; cursor: pointer; transition: all 0.2s;
        }
        .preset-chip:hover { background: #2a2a2a; color: white; border-color: #555; }

        .tab-btn {
            background: transparent; color: #707070; padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent; transition: all 0.2s; font-weight: 500;
        }
        .tab-btn.active { color: white; border-bottom-color: #3b82f6; }
        
        .stat-card {
            background: #0d0d0d; border: 1px solid #1a1a1a; border-radius: 0.75rem;
            padding: 1.5rem; display: flex; flex-direction: column; align-items: center;
            justify-content: center; transition: border-color 0.2s;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .live-indicator {
            width: 8px; height: 8px; background: #22c55e; border-radius: 50%;
            display: inline-block; margin-right: 6px; animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="page-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
        
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Analytics Dashboard</h1>
                <p class="text-gray-400 flex items-center">
                    <span class="live-indicator"></span> Real-time System Overview
                </p>
            </div>
            <div class="flex gap-4 border-b border-[#1a1a1a] w-full sm:w-auto overflow-x-auto">
                <button class="tab-btn active whitespace-nowrap" data-tab="users">User Management</button>
                <button class="tab-btn whitespace-nowrap" data-tab="traffic">Site Traffic</button>
                <button class="tab-btn whitespace-nowrap" data-tab="health">System Health</button>
            </div>
        </header>

        <div id="tab-users" class="tab-content">
            <div id="sync-stats-card" class="bg-[#0d0d0d] border border-[#1a1a1a] rounded-xl p-4 mb-6 flex justify-between items-center">
                <div class="flex gap-8">
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-xs uppercase tracking-widest">Auth Users</span>
                        <span id="auth-user-count" class="text-2xl text-white font-mono">--</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-xs uppercase tracking-widest">DB Users</span>
                        <span id="db-user-count" class="text-2xl text-white font-mono">--</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-xs uppercase tracking-widest text-red-400">Missing</span>
                        <span id="missing-user-count" class="text-2xl text-red-400 font-mono">--</span>
                    </div>
                </div>
                <button id="mass-sync-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition hidden">
                    Mass Add Missing
                </button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <span class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Total Users</span>
                    <span id="total-users-count" class="text-4xl text-white font-light">--</span>
                </div>
                <div class="stat-card">
                    <span class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Admins</span>
                    <span id="total-admins-count" class="text-4xl text-blue-400 font-light">--</span>
                </div>
                <div class="stat-card">
                    <span class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Banned</span>
                    <span id="total-banned-count" class="text-4xl text-red-400 font-light">--</span>
                </div>
                <div class="stat-card">
                    <span class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Verified Emails</span>
                    <span id="total-verified-count" class="text-4xl text-green-400 font-light">--</span>
                </div>
            </div>

            <div class="chart-container mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white text-lg">User Growth</h3>
                    <select id="chart-period" class="bg-[#1a1a1a] text-gray-300 border border-[#333] rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500">
                        <option value="week">Past Week</option>
                        <option value="month" selected>Past Month</option>
                        <option value="year">Past Year</option>
                    </select>
                </div>
                <div class="relative h-full w-full" style="height: 220px;">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>

            <div class="bg-[#0d0d0d] border border-[#1a1a1a] rounded-xl overflow-hidden">
                <div class="p-4 border-b border-[#1a1a1a] flex justify-between items-center flex-wrap gap-4 bg-[#0a0a0a]">
                    <div class="flex items-center gap-2">
                        <h3 class="text-white text-lg">User Directory</h3>
                        <span class="text-xs bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded border border-blue-500/20">Firestore Synced</span>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="user-search" placeholder="Search users..." class="bg-[#1a1a1a] text-white border border-[#333] rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500 w-64">
                        <select id="user-sort" class="bg-[#1a1a1a] text-gray-300 border border-[#333] rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="admin">Admins First</option>
                            <option value="verified">Verified First</option>
                        </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Identity</th>
                                <th>Auth Method</th>
                                <th>Joined</th>
                                <th>Verification</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
                <div id="loading-users" class="p-8 text-center text-gray-500">
                    <i class="fa-solid fa-circle-notch fa-spin mr-2 text-blue-500"></i> Connecting to live user feed...
                </div>
            </div>
        </div>

        <div id="tab-traffic" class="tab-content hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                 <div class="stat-card">
                    <div class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Total Sessions</div>
                    <div id="stat-total-sessions" class="text-3xl text-white font-light">--</div>
                </div>
                <div class="stat-card">
                    <div class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Avg Duration</div>
                    <div id="stat-avg-duration" class="text-3xl text-blue-400 font-light">--</div>
                </div>
                 <div class="stat-card">
                    <div class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Total Views</div>
                    <div id="stat-total-views" class="text-3xl text-purple-400 font-light">--</div>
                </div>
                 <div class="stat-card">
                    <div class="text-gray-400 text-sm mb-2 uppercase tracking-wide">Active (24h)</div>
                    <div id="stat-active-24h" class="text-3xl text-green-400 font-light">--</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-[#0d0d0d] border border-[#1a1a1a] rounded-xl overflow-hidden h-fit">
                    <div class="p-4 border-b border-[#1a1a1a] bg-[#0a0a0a]">
                        <h3 class="text-white text-lg">Top Pages</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Page Path</th>
                                    <th>Title</th>
                                    <th class="text-right">Visits</th>
                                </tr>
                            </thead>
                            <tbody id="top-pages-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-[#0d0d0d] border border-[#1a1a1a] rounded-xl overflow-hidden h-fit">
                    <div class="p-4 border-b border-[#1a1a1a] bg-[#0a0a0a]">
                         <h3 class="text-white text-lg">Recent Sessions</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>User / Email</th>
                                    <th>Time Ago</th>
                                    <th>Duration</th>
                                    <th>Pages</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sessions-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-health" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="chart-container">
                    <h3 class="text-white text-lg mb-4">Browser Distribution</h3>
                    <div class="relative h-full w-full" style="height: 220px;">
                        <canvas id="browserChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="text-white text-lg mb-4">OS Distribution</h3>
                    <div class="relative h-full w-full" style="height: 220px;">
                        <canvas id="osChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-6 border-b border-[#333] pb-4">
                <h3 class="text-xl text-white font-light">User Profile</h3>
                <button id="close-user-modal" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div id="user-modal-body" class="space-y-4"></div>
        </div>
    </div>

    <div id="ban-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-6 border-b border-[#333] pb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-900/20 flex items-center justify-center text-red-500">
                        <i class="fa-solid fa-gavel"></i>
                    </div>
                    <h3 class="text-xl text-white font-light">Ban User</h3>
                </div>
                <button id="close-ban-modal" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-300 text-sm bg-[#111] p-3 rounded border border-[#333]" id="ban-user-target">Target: ...</p>
                <div>
                    <label class="block text-xs text-gray-500 uppercase tracking-widest mb-2">Ban Reason</label>
                    <textarea id="ban-reason" class="w-full bg-[#111] text-white border border-[#333] rounded-lg p-3 text-sm focus:outline-none focus:border-red-500 min-h-[100px]" placeholder="Enter reason for ban..."></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#333]">
                    <button id="cancel-ban" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Cancel</button>
                    <button id="confirm-ban" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition font-medium">Confirm Ban</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
        import { 
            getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteDoc,
            updateDoc, query, orderBy, limit, onSnapshot, writeBatch, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { firebaseConfig } from "../firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        let allUsers = [];
        let missingAuthUsers = [];
        let allSessions = [];
        let admins = new Set();
        let bannedUsers = new Set();
        let chartInstance = null;
        let browserChartInstance = null;
        let osChartInstance = null;
        let userToBan = null;

        const providerImages = {
            'google.com': '../images/google-icon.png',
            'microsoft.com': '../images/microsoft.png',
            'github.com': '../images/github-mark-white.png',
            'twitter.com': '../images/x.png',
            'password': 'fa-solid fa-envelope',
            'email': 'fa-solid fa-envelope'
        };

        const init = async () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                    const isSuperAdmin = user.email === '4simpleproblems@gmail.com';
                    if (adminDoc.exists() || isSuperAdmin) {
                        subscribeToData();
                        loadTrafficData();
                    } else {
                        window.location.href = '../logged-in/dashboard.html';
                    }
                } else {
                    window.location.href = '../index.html';
                }
            });
            setupTabs();
        };

        const setupTabs = () => {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
                });
            });
        };

        const checkAuthSync = async () => {
            const syncBtn = document.getElementById('mass-sync-btn');
            try {
                const getAuthUsers = httpsCallable(functions, 'getAuthUsers');
                const result = await getAuthUsers();
                const authUsers = result.data;
                const dbUserIds = new Set(allUsers.map(u => u.id));
                missingAuthUsers = authUsers.filter(u => !dbUserIds.has(u.uid));

                document.getElementById('auth-user-count').textContent = authUsers.length;
                document.getElementById('db-user-count').textContent = allUsers.length;
                document.getElementById('missing-user-count').textContent = missingAuthUsers.length;

                if (missingAuthUsers.length > 0) {
                    syncBtn.classList.remove('hidden');
                    syncBtn.textContent = `Mass Add ${missingAuthUsers.length} Users`;
                } else {
                    syncBtn.classList.add('hidden');
                }
            } catch (e) { console.error("Sync check failed", e); }
        };

        const subscribeToData = () => {
            onSnapshot(collection(db, 'bans'), (snap) => {
                bannedUsers = new Set(snap.docs.map(d => d.id));
                document.getElementById('total-banned-count').textContent = bannedUsers.size;
                renderTable(getFilteredUsers());
            });

            onSnapshot(collection(db, 'admins'), (snap) => {
                admins = new Set(snap.docs.map(d => d.id));
                document.getElementById('total-admins-count').textContent = admins.size;
                renderTable(getFilteredUsers());
            });

            const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snap) => {
                allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('total-users-count').textContent = allUsers.length;
                document.getElementById('total-verified-count').textContent = allUsers.filter(u => u.emailVerified).length;
                document.getElementById('loading-users').style.display = 'none';
                renderTable(getFilteredUsers());
                renderChart(allUsers);
                checkAuthSync();
            });
        };

        const renderTable = (users) => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = users.map(user => {
                const isAdmin = admins.has(user.id);
                const isBanned = bannedUsers.has(user.id);
                return `
                <tr>
                    <td>
                        <div class="flex flex-col">
                            <span class="text-white font-medium">${user.username || 'Unknown'} ${isAdmin ? '⭐' : ''}</span>
                            <span class="text-xs text-gray-500">${user.email || user.id}</span>
                        </div>
                    </td>
                    <td>${user.authMethod || '---'}</td>
                    <td class="text-gray-400 text-xs">${user.createdAt?.toDate ? user.createdAt.toDate().toLocaleDateString() : '---'}</td>
                    <td>${user.emailVerified ? '✅' : '❌'}</td>
                    <td><span class="${isBanned ? 'text-red-500' : 'text-green-500'}">${isBanned ? 'Banned' : 'Active'}</span></td>
                    <td>
                         <button class="action-btn ${isBanned ? 'btn-unblock' : 'btn-block'}" data-uid="${user.id}" onclick="handleBan('${user.id}', ${isBanned})">
                            <i class="fa-solid ${isBanned ? 'fa-unlock' : 'fa-ban'}"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        };

        const renderChart = (users) => {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            const period = document.getElementById('chart-period').value;
            // Simplified grouping for chart
            const groups = {};
            users.forEach(u => {
                const d = u.createdAt?.toDate ? moment(u.createdAt.toDate()).format('YYYY-MM-DD') : null;
                if(d) groups[d] = (groups[d] || 0) + 1;
            });

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(groups).sort(),
                    datasets: [{ label: 'New Users', data: Object.values(groups), borderColor: '#3b82f6', fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        const loadTrafficData = async () => {
            const q = query(collection(db, 'analytics'), orderBy('lastActive', 'desc'), limit(100));
            const snap = await getDocs(q);
            allSessions = snap.docs.map(d => d.data());
            document.getElementById('stat-total-sessions').textContent = allSessions.length;
        };

        const getFilteredUsers = () => {
            const search = document.getElementById('user-search').value.toLowerCase();
            return allUsers.filter(u => (u.username || '').toLowerCase().includes(search) || (u.email || '').toLowerCase().includes(search));
        };

        document.getElementById('user-search').addEventListener('input', () => renderTable(getFilteredUsers()));
        document.getElementById('chart-period').addEventListener('change', () => renderChart(allUsers));

        init();
    </script>
</body>
</html>
