<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - VANA</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>

    <script>
        if(window.console && console.warn) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if(args[0] && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        }
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { accent: '#4f46e5' },
                    fontFamily: { sans: ['Geist', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";
        
        // Import Config from external file
        import { firebaseConfig } from "../firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app); // Defaults to us-central1
        
        // Make the function available globally
        window.chatWithGroq = httpsCallable(functions, 'chatWithGroq');
    </script>

    <style>
        :root {
            --bg-color: #040404;
            --toolbar-bg: #000000;
            --item-border: #333;
            --accent: #4f46e5;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            
            --menu-bg: #0a0a0a;
            --menu-border: #333;
            --menu-text: #d1d5db;
            --menu-item-hover-bg: rgba(79, 70, 229, 0.1);
            --menu-item-hover-text: #ffffff;
            --menu-item-hover-border: #4f46e5;
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-weight: 300;
        }

        /* --- Header Styles --- */
        header {
            background-color: var(--toolbar-bg);
            border-bottom: 1px solid var(--item-border);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            flex-shrink: 0;
            z-index: 50;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 1px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .brand i { color: var(--accent); }

        /* --- Dropdown Styles --- */
        .auth-controls-wrapper { position: relative; }

        .auth-toggle {
            border: 1px solid var(--item-border);
            border-radius: 14px;
            padding: 0.5rem 1rem;
            background: #000;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            min-width: 180px;
            justify-content: space-between;
        }
        .auth-toggle:hover {
            border-color: var(--text-muted);
            color: #fff;
        }

        .auth-menu-container {
            position: absolute; right: 0; top: 55px; width: 16rem;
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            border-radius: 1.25rem; 
            padding: 0.75rem; 
            display: none; /* DEFAULT CLOSED */
            flex-direction: column; gap: 0.5rem; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transform-origin: top right; z-index: 10000;
        }

        @keyframes menu-pop-in {
            0% { opacity: 0; transform: translateY(-10px) scale(0.95); }
            70% { transform: translateY(2px) scale(1.01); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-menu-container.open { 
            display: flex !important; 
            animation: menu-pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .auth-menu-link { 
            display: flex; align-items: center; gap: 0.75rem; width: 100%; text-align: left; 
            padding: 0.75rem 1rem; font-size: 0.9rem; color: var(--menu-text); 
            background: rgba(79, 70, 229, 0.05); 
            border-radius: 14px; 
            transition: all 0.2s ease; cursor: pointer;
            border: 1px solid transparent;
        }
        .auth-menu-link:hover { 
            background-color: var(--menu-item-hover-bg); 
            border-color: var(--menu-item-hover-border);
            color: var(--menu-item-hover-text);
            transform: translateY(-2px) scale(1.02);
        }
        .auth-menu-link.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(79, 70, 229, 0.1);
        }

        /* --- Chat Area --- */
        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            scroll-behavior: smooth;
            padding-bottom: 4rem; 
        }
        
        #chat-container::-webkit-scrollbar { display: none; }

        .message {
            display: flex;
            gap: 1rem;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            max-width: 100%;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .message.user { flex-direction: row-reverse; }
        
        .avatar {
            width: 36px; height: 36px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        .avatar.ai { background: linear-gradient(135deg, #4f46e5 0%, #312e81 100%); color: white; }
        .avatar.user { background: #222; border: 1px solid #333; color: #ccc; }

        .bubble {
            background: #111;
            border: 1px solid #333;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #e5e7eb;
            max-width: 85%;
            overflow-wrap: break-word;
        }
        .message.user .bubble {
            background: rgba(79, 70, 229, 0.1);
            border-color: rgba(79, 70, 229, 0.3);
            color: #fff;
        }

        /* --- Rich Content Styles --- */
        .bubble pre { background: #000; padding: 10px; border-radius: 8px; overflow-x: auto; margin-top: 10px; border: 1px solid #333; }
        .bubble code { font-family: 'Courier New', monospace; font-size: 0.9em; color: #a5b4fc; }
        .bubble p { margin-bottom: 0.5rem; }
        .bubble p:last-child { margin-bottom: 0; }
        .bubble ul, .bubble ol { margin: 10px 0; padding-left: 20px; list-style-position: outside; }
        .bubble li { margin-bottom: 5px; list-style: disc; }

        /* Code/Chart Block Wrapper */
        .code-block-wrapper, .chart-block-wrapper {
            background-color: #0d0d0d; border-radius: 12px; margin: 15px 0;
            overflow: hidden; border: 1px solid #1a1a1a;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .code-block-header, .chart-block-header {
            display: flex; justify-content: space-between; align-items: center; 
            padding: 6px 12px; background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid #222;
        }
        .code-metadata, .chart-metadata { font-size: 0.8em; color: #aaa; font-family: monospace; }
        
        /* Charts */
        .unified-chart-placeholder { min-height: 300px; padding: 15px; display: flex; flex-direction: column; background: #000; }
        .chart-canvas { width: 100%; height: 250px; }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding-top: 10px; border-top: 1px solid #222; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8em; color: #ccc; }
        .legend-color { width: 10px; height: 10px; border-radius: 2px; }

        /* File Creation Card */
        .gemini-file-creation-card {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.1), rgba(52, 168, 83, 0.05));
            border: 1px solid rgba(66, 133, 244, 0.2);
            border-radius: 12px; padding: 12px; width: 220px; margin-top: 10px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .file-header { display: flex; justify-content: space-between; align-items: center; }
        .file-name { font-size: 0.9rem; color: #fff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-creation-download-btn {
            background: var(--accent); color: white; border-radius: 6px; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; text-decoration: none;
        }

        /* --- Input Area --- */
        .input-wrapper { 
            padding: 1.5rem; 
            max-width: 900px; 
            margin: 0 auto; 
            width: 100%; 
            position: relative; 
        }

        .input-box {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 26px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            transition: border-color 0.2s;
            position: relative;
        }
        .input-box:focus-within { border-color: var(--accent); }

        textarea {
            background: transparent; 
            border: none; 
            color: white;
            padding: 0; 
            margin: 0;
            width: 100%; 
            outline: none; 
            resize: none !important;
            font-family: 'Geist', sans-serif; 
            font-size: 1rem;
            line-height: 1.5;
            height: 24px;
            max-height: 150px;
            flex-grow: 1;
        }

        /* Send Button */
        .send-btn {
            height: 38px; width: 38px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
            background: #1e1b4b; /* Dark Purple */
            border: 1px solid var(--accent); /* Purple Outline */
            color: #fff;
        }
        .send-btn:hover {
            background: var(--accent);
            color: #ffffff; 
            border-color: #fff;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.4);
        }
        .send-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
            background: #1e1b4b !important; /* Keep purple */
            border-color: var(--accent) !important;
        }

        /* Character Counter */
        .char-counter {
            position: absolute;
            bottom: -22px;
            right: 20px;
            font-size: 0.75rem;
            color: #555;
            font-family: monospace;
            transition: color 0.2s;
        }
        .char-counter.limit { color: #ef4444; }

        /* Tier Badge (Model Switch Notification) */
        .tier-badge {
            width: 100%; text-align: center; margin: 15px 0;
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.4s ease;
        }
        .tier-badge span {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #888;
            font-size: 0.75em;
            padding: 4px 12px;
            border-radius: 12px;
            font-family: 'Geist', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Delete Button */
        #clear-chat-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 45px; height: 45px;
            background: #111;
            border: 1px solid #333;
            color: #ef4444; /* Red */
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.2s ease;
            z-index: 100;
        }
        #clear-chat-btn:hover {
            background: #1a1a1a;
            transform: scale(1.1);
            border-color: #ef4444;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fa-solid fa-robot"></i>
            <span>VANA</span>
        </div>

        <div class="auth-controls-wrapper" id="dropdown-wrapper">
            <button id="model-toggle" class="auth-toggle">
                <span id="current-model-display"><i class="fa-solid fa-bolt mr-2"></i>Llama 3.1 8B (Fast)</span>
                <i class="fa-solid fa-chevron-down"></i>
            </button>
            <div id="model-menu" class="auth-menu-container">
                <div class="text-xs text-gray-500 uppercase font-bold px-3 py-2">Select Model</div>
                
                <button class="auth-menu-link active" onclick="setModel('llama-3.1-8b-instant', 'Llama 3.1 8B (Fast)', this)">
                    <i class="fa-solid fa-bolt w-4"></i>
                    <div>
                        <div class="font-medium">Llama 3.1 8B</div>
                        <div class="text-xs text-gray-500">Fastest response</div>
                    </div>
                </button>

                <button class="auth-menu-link" onclick="setModel('llama-3.3-70b-versatile', 'Llama 3.3 70B (Smart)', this)">
                    <i class="fa-solid fa-brain w-4"></i>
                    <div>
                        <div class="font-medium">Llama 3.3 70B</div>
                        <div class="text-xs text-gray-500">Highest intelligence</div>
                    </div>
                </button>

                <button class="auth-menu-link" onclick="setModel('openai/gpt-oss-120b', 'GPT-OSS 120B', this)">
                    <i class="fa-solid fa-code-branch w-4"></i>
                    <div>
                        <div class="font-medium">GPT-OSS 120B</div>
                        <div class="text-xs text-gray-500">Open source powerhouse</div>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <div id="chat-container">
        <div class="message ai">
            <div class="avatar ai"><i class="fa-solid fa-v"></i></div>
            <div class="bubble">
                <p>Hello! I am Vana.</p>
                <p>I can help you with analysis, coding, math, and visualizing data.</p>
            </div>
        </div>
    </div>

    <div class="input-wrapper">
        <div class="input-box">
            <textarea 
                id="user-input" 
                placeholder="Type a message to Vana..." 
                rows="1" 
                maxlength="5000"
                oninput="handleInput(this)"></textarea>
            
            <button id="send-btn" class="send-btn" onclick="sendMessage()" title="Send Message">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
            <div id="char-counter" class="char-counter">0 / 5000</div>
        </div>
    </div>

    <button id="clear-chat-btn" onclick="clearChat()" title="Clear Conversation">
        <i class="fa-solid fa-trash"></i>
    </button>

    <script>
        // --- CONFIGURATION ---
        // Model IDs
        const MODELS = {
            FAST: 'llama-3.1-8b-instant',
            SMART: 'llama-3.3-70b-versatile',
            GPT: 'openai/gpt-oss-120b'
        };

        const MODEL_NAMES = {
            [MODELS.FAST]: 'Llama 3.1 8B (Fast)',
            [MODELS.SMART]: 'Llama 3.3 70B (Smart)',
            [MODELS.GPT]: 'GPT-OSS 120B'
        };
        
        let currentModel = MODELS.FAST;
        let currentModelName = MODEL_NAMES[MODELS.FAST];
        const MAX_CHARS = 5000;
        
        // --- STATE ---
        let conversationHistory = [];

        // --- PROXY & SEARCH ---
        const Ultraviolet = {
            codec: {
                xor: {
                    encode(str) {
                        if (!str) return str;
                        return encodeURIComponent(str.split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join(''));
                    },
                    decode(str) {
                        if (!str) return str;
                        let [input, ...search] = str.split('?');
                        return decodeURIComponent(input).split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join('') + (search.length ? '?' + search.join('?') : '');
                    },
                },
            },
        };

        async function searchWeb(query) {
            const baseUrl = "https://api.duckduckgo.com/?q=" + encodeURIComponent(query) + "&format=json";
            const proxiedUrl = "/VERN/uv/service/" + Ultraviolet.codec.xor.encode(baseUrl);
            
            try {
                const response = await fetch(proxiedUrl);
                const data = await response.json();
                
                let result = `Search Results for "${query}":\n\n`;
                if (data.AbstractText) {
                    result += `Abstract: ${data.AbstractText}\nSource: ${data.AbstractSource}\nURL: ${data.AbstractURL}\n\n`;
                }
                
                if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                    result += "Related Topics:\n";
                    data.RelatedTopics.slice(0, 5).forEach(topic => {
                        if (topic.Text) {
                            result += `- ${topic.Text} (${topic.FirstURL})\n`;
                        } else if (topic.Topics) {
                            topic.Topics.slice(0, 3).forEach(subTopic => {
                                result += `- ${subTopic.Text} (${subTopic.FirstURL})\n`;
                            });
                        }
                    });
                }
                
                if (!data.AbstractText && (!data.RelatedTopics || data.RelatedTopics.length === 0)) {
                    result += "No detailed results found, but the search was successfully executed via DuckDuckGo API.";
                }
                
                return result;
            } catch (error) {
                console.error("Search Error:", error);
                return "Error performing search: " + error.message;
            }
        }

        // --- SYSTEM PROMPT ---
        const SYSTEM_PROMPT = `
You are Vana, a highly capable AI assistant.

**Capabilities:**
1. **Math**: Use LaTeX for equations. Inline: $...$, Block: $$...$$.
2. **Coding**: Provide code blocks with language specifiers.
3. **Files**: If the user asks for a file, use the <CREATE_FILE> tag.
4. **Charts**: To visualize data, use a \`\`\`chart\`\`\` block with the JSON schema below.
5. **Web Search**: If you need real-time information, latest news, or details you are unsure of, use the <SEARCH>query</SEARCH> tag. I will perform the search and provide you with results to help you answer.

**JSON Schema for Charts:**
\`\`\`json
{
  "type": "line" | "bar" | "scatter",
  "data": {
    "labels": ["X1", "X2"],
    "datasets": [
      {
        "label": "Series Name",
        "data": [10, 20],
        "borderColor": "#4f46e5",
        "tension": 0.4 
      }
    ]
  }
}
\`\`\`
For curved lines (functions), set "tension": 0.4. For straight lines, set 0.

**File Creation Syntax:**
<CREATE_FILE FILENAME="script.py" MIMETYPE="text/x-python">
print("Hello World")
</CREATE_FILE>
`;

        conversationHistory.push({ role: "system", content: SYSTEM_PROMPT });

        // --- DROPDOWN LOGIC (FIXED) ---
        const toggleBtn = document.getElementById('model-toggle');
        const menu = document.getElementById('model-menu');
        const wrapper = document.getElementById('dropdown-wrapper');
        const display = document.getElementById('current-model-display');

        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevents the document listener from firing immediately
            if (menu.classList.contains('open')) {
                closeMenu();
            } else {
                openMenu();
            }
        });

        function openMenu() { 
            menu.classList.add('open'); 
        }

        function closeMenu() { 
            menu.classList.remove('open'); 
        }
        
        window.setModel = (modelId, displayName, element) => {
            if (currentModel !== modelId) {
                // Update State
                currentModel = modelId;
                currentModelName = displayName;
                
                // Update Header UI
                updateHeaderUI(modelId);
                
                // Notify in Chat
                addSystemBadge(`Switched to ${displayName}`);
            }
            closeMenu();
        };

        // CLOSE ON CLICK OUTSIDE
        document.addEventListener('click', (e) => {
            // If menu is open and click is OUTSIDE the wrapper
            if (menu.classList.contains('open') && !wrapper.contains(e.target)) {
                closeMenu();
            }
        });

        // --- INPUT HANDLING ---
        function handleInput(el) {
            // Auto-grow
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
            
            // Character Counter
            const count = el.value.length;
            const counterEl = document.getElementById('char-counter');
            counterEl.textContent = `${count} / ${MAX_CHARS}`;
            if(count >= MAX_CHARS) counterEl.classList.add('limit');
            else counterEl.classList.remove('limit');
        }

        // --- CHAT LOGIC ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function clearChat() {
            if(!confirm("Are you sure you want to clear the conversation?")) return;
            chatContainer.innerHTML = '';
            conversationHistory = [{ role: "system", content: SYSTEM_PROMPT }];
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai';
            msgDiv.innerHTML = `<div class="avatar ai"><i class="fa-solid fa-v"></i></div><div class="bubble"><p>Conversation cleared. Ready for new input.</p></div>`;
            chatContainer.appendChild(msgDiv);
        }

        function addSystemBadge(text) {
            const badge = document.createElement('div');
            badge.className = 'tier-badge';
            badge.innerHTML = `<span>${text}</span>`;
            chatContainer.appendChild(badge);
            scrollToBottom();
        }

        // --- MAIN SEND LOGIC ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessageToUI('user', text);
            conversationHistory.push({ role: "user", content: text });

            userInput.value = '';
            userInput.style.height = '24px';
            document.getElementById('char-counter').textContent = `0 / ${MAX_CHARS}`;

            let aiBubble = addMessageToUI('ai', '<i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...', true);
            sendBtn.disabled = true;

            try {
                // Wait for the window.chatWithGroq function to be available (from module script)
                if (!window.chatWithGroq) throw new Error("Firebase not initialized yet. Please wait.");

                // 1. First Attempt
                let response = await callCloudFunction(currentModel);

                // 2. Carousel Logic
                if (response.error && response.code === 'resource-exhausted') {
                    let nextModel = null;
                    
                    // Carousel Order Logic
                    if (currentModel === MODELS.FAST) nextModel = MODELS.SMART;
                    else if (currentModel === MODELS.SMART) nextModel = MODELS.FAST;
                    else if (currentModel === MODELS.GPT) nextModel = MODELS.SMART;

                    if (nextModel) {
                        aiBubble.remove();
                        addSystemBadge(`Rate Limit on ${MODEL_NAMES[currentModel]}. Switching to ${MODEL_NAMES[nextModel]}...`);
                        
                        currentModel = nextModel;
                        updateHeaderUI(currentModel);
                        
                        aiBubble = addMessageToUI('ai', '<i class="fa-solid fa-circle-notch fa-spin"></i> Retrying...', true);
                        
                        response = await callCloudFunction(currentModel);

                        // 3. Third Step (GPT -> Smart -> Fast)
                        if (response.error && response.code === 'resource-exhausted' && currentModel === MODELS.SMART) {
                            nextModel = MODELS.FAST;
                            
                            aiBubble.remove();
                            addSystemBadge(`Rate Limit on Smart. Switching to ${MODEL_NAMES[nextModel]}...`);
                            
                            currentModel = nextModel;
                            updateHeaderUI(currentModel);
                            
                            aiBubble = addMessageToUI('ai', '<i class="fa-solid fa-circle-notch fa-spin"></i> Retrying...', true);
                            
                            response = await callCloudFunction(currentModel);
                        }
                    }
                }

                // 4. Final Check
                if (response.error) {
                    if (response.code === 'resource-exhausted') {
                        throw new Error("Rate limit reached. Please wait 1 minute before trying again.");
                    } else {
                        throw new Error(response.message || "Unknown error");
                    }
                }

                // Success
                let aiText = response.data.choices[0].message.content;

                // --- SEARCH LOOP ---
                const searchMatch = aiText.match(/<SEARCH>(.*?)<\/SEARCH>/i);
                if (searchMatch) {
                    const query = searchMatch[1];
                    aiBubble.innerHTML = `<i class="fa-solid fa-magnifying-glass fa-spin mr-2"></i> Searching for "${query}"...`;
                    
                    const searchResults = await searchWeb(query);
                    conversationHistory.push({ role: "assistant", content: aiText });
                    conversationHistory.push({ role: "system", content: `Search Results: ${searchResults}` });
                    
                    // Call AI again with search results
                    response = await callCloudFunction(currentModel);
                    if (response.error) throw new Error(response.message || "Error after search");
                    aiText = response.data.choices[0].message.content;
                }

                const parsedContent = parseAIResponse(aiText);
                aiBubble.innerHTML = parsedContent;
                renderUnifiedCharts(aiBubble);
                renderKaTeX(aiBubble);
                conversationHistory.push({ role: "assistant", content: aiText });

            } catch (error) {
                aiBubble.innerHTML = `<span class="text-red-500"><i class="fa-solid fa-triangle-exclamation mr-2"></i> ${error.message}</span>`;
            } finally {
                sendBtn.disabled = false;
                scrollToBottom();
            }
        }

        // Wrapper to handle Firebase errors cleanly
        async function callCloudFunction(model) {
            try {
                const result = await window.chatWithGroq({
                    messages: conversationHistory,
                    model: model
                });
                return { data: result.data };
            } catch (e) {
                return { error: true, code: e.code, message: e.message };
            }
        }

        function updateHeaderUI(modelId) {
            currentModelName = MODEL_NAMES[modelId];
            let icon = 'fa-brain';
            if(modelId.includes('8b')) icon = 'fa-bolt';
            if(modelId.includes('gpt-oss')) icon = 'fa-code-branch';
            
            const display = document.getElementById('current-model-display');
            display.innerHTML = `<i class="fa-solid ${icon} mr-2"></i>${currentModelName}`;
            
            // Update menu active state
            document.querySelectorAll('.auth-menu-link').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerHTML.includes(currentModelName.split(' ')[0])) btn.classList.add('active'); 
            });
        }

        function addMessageToUI(role, htmlContent, isLoading = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            
            const avatar = role === 'ai' ? '<i class="fa-solid fa-v"></i>' : '<i class="fa-solid fa-user"></i>';
            const content = isLoading ? htmlContent : (role === 'ai' ? htmlContent : marked.parse(htmlContent));
            
            msgDiv.innerHTML = `
                <div class="avatar ${role}">${avatar}</div>
                <div class="bubble">${content}</div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            return msgDiv.querySelector('.bubble');
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- UTILS (Rendering) ---
        function parseAIResponse(text) {
            let html = text.replace(/<SEARCH>.*?<\/SEARCH>/gi, '');
            
            // Charts
            html = html.replace(/```chart\n([\s\S]*?)```/g, (match, json) => {
                return `<div class="chart-block-wrapper">
                    <div class="unified-chart-placeholder" data-chart-data='${escapeHTML(json)}'>
                        <canvas class="chart-canvas"></canvas>
                        <div class="chart-legend"></div>
                    </div>
                </div>`;
            });

            // Files
            html = html.replace(/<CREATE_FILE FILENAME="([^"]+)" MIMETYPE="([^"]+)">([\s\S]*?)<\/CREATE_FILE>/g, (m, f, t, c) => {
                const blob = new Blob([c], {type:t});
                return `<div class="gemini-file-creation-card">
                    <div class="file-header">
                        <div class="file-name">${f}</div>
                        <a href="${URL.createObjectURL(blob)}" download="${f}" class="file-creation-download-btn"><i class="fa-solid fa-download"></i></a>
                    </div>
                </div>`;
            });
            
            return marked.parse(html);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));
        }

        function renderKaTeX(c) {
            if(typeof katex!=='undefined') {
                c.innerHTML = c.innerHTML
                    .replace(/\$\$([\s\S]*?)\$\$/g, (m,t)=>katex.renderToString(t,{displayMode:true}))
                    .replace(/\$([^\$]+)\$/g, (m,t)=>katex.renderToString(t,{displayMode:false}));
            }
        }

        function renderUnifiedCharts(c) {
            c.querySelectorAll('.unified-chart-placeholder').forEach(p => {
                try {
                    renderChartJSClone(p.querySelector('canvas'), JSON.parse(p.dataset.chartData), p.nextElementSibling);
                } catch(e){ p.innerHTML='Error'; }
            });
        }

        // Simplified Chart Engine
        function renderChartJSClone(canvas, config, legend) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio||1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width*dpr;
            canvas.height = rect.height*dpr;
            ctx.scale(dpr,dpr);

            const { type, data } = config;
            const P = {t:20,r:20,b:40,l:40};
            const W=rect.width-P.l-P.r, H=rect.height-P.t-P.b;
            const colors = ['#4f46e5','#ef4444','#10b981','#f59e0b'];

            if(legend) legend.innerHTML = data.datasets.map((d,i)=>`<div class="legend-item"><span class="legend-color" style="background:${d.borderColor||colors[i]}"></span>${d.label}</div>`).join('');
            
            let min=Infinity, max=-Infinity;
            data.datasets.forEach(d=>d.data.forEach(v=>{
                const y=typeof v==='object'?v.y:v;
                min=Math.min(min,y); max=Math.max(max,y);
            }));
            if(min===Infinity){min=0;max=10;}
            const rng = max-min||1;
            
            const mapY = v => P.t + H - ((v-min)/rng)*H;
            const mapX = (i,n) => P.l + (i*(W/(n-1||1)));

            ctx.strokeStyle='#333'; ctx.beginPath();
            ctx.moveTo(P.l,P.t); ctx.lineTo(P.l,P.t+H); ctx.lineTo(P.l+W,P.t+H);
            ctx.stroke(); 

            data.datasets.forEach((d,di)=>{
                ctx.strokeStyle=ctx.fillStyle=d.borderColor||colors[di%4];
                ctx.lineWidth=2;

                if(type==='line'||type==='scatter'){
                    ctx.beginPath();
                    const pts = d.data.map((v,i)=>({x:mapX(i,d.data.length), y:mapY(typeof v==='object'?v.y:v)}));

                    if(type==='line'){
                        if(d.tension && pts.length>2) {
                            ctx.moveTo(pts[0].x,pts[0].y);
                            for(let i=0;i<pts.length-1;i++){
                                const mx=(pts[i].x+pts[i+1].x)/2;
                                ctx.bezierCurveTo(mx,pts[i].y,mx,pts[i+1].y,pts[i+1].x,pts[i+1].y);
                            }
                        } else {
                            pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
                        }
                        ctx.stroke();
                    }
                    pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,6.28);ctx.fill();});
                }
                
                if(type==='bar'){
                    const bw=(W/d.data.length)*0.6;
                    d.data.forEach((v,i)=>{
                        ctx.fillRect(mapX(i,d.data.length)-bw/2, mapY(v), bw, (P.t+H)-mapY(v));
                    });
                }
            });
        }
    </script>
</body>
</html>
