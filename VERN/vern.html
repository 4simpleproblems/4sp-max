<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERN</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Aggressive Preloading -->
    <link rel="preload" href="/VERN/uv/uv.bundle.js" as="script">
    <link rel="preload" href="/VERN/baremux/index.js" as="script">
    <link rel="preload" href="/VERN/baremux/worker.js" as="worker">
    <link rel="preload" href="/VERN/uv/sw.js" as="worker">

    <!-- Sync Loading for Critical Proxy Scripts -->
    <script src="uv/uv.bundle.js"></script>
    <!-- Inline Config for Speed -->
    <script>
        const basePath = "/VERN/uv/";
        self.__uv$config = {
            prefix: basePath + "service/",
            encodeUrl: Ultraviolet.codec.xor.encode,
            decodeUrl: Ultraviolet.codec.xor.decode,
            handler: basePath + "uv.handler.js",
            client: basePath + "uv.client.js",
            bundle: basePath + "uv.bundle.js",
            config: basePath + "uv.config.js",
            sw: basePath + "uv.sw.js",
            stockSW: basePath + "sw.js",
        };
    </script>
    <script src="baremux/index.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ... existing styles ... */
        :root {
            --bg-color: #040404;
            --toolbar-bg: #000000;
            --item-bg: #000000;
            --item-border: #333;
            --item-hover-bg: #000000;
            --accent: #4f46e5;
            --text-main: #e5e7eb;
            --text-muted: #d1d5db;
            --radius: 1rem; /* Increased from 0.75rem for more rounded look */
            --control-size: 42px;
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-muted); 
            transition: all 0.3s ease;
            font-size: 14px;
            overflow: hidden;
            font-weight: 300; /* Thinner font */
        }

        h1, h2, h3, .font-bold, .font-semibold, strong {
            font-weight: 400 !important;
        }

        /* Toolbar Container */
        header {
            background-color: var(--toolbar-bg);
            border-bottom: 1px solid var(--item-border);
        }

        /* Common Control Style (Matches btn-toolbar-style) */
        .control-btn, .tab {
            height: var(--control-size);
            border-radius: var(--radius);
            background: var(--item-bg);
            border: 1px solid var(--item-border);
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
            padding: 0 1rem; /* Added padding like toolbar buttons */
            font-weight: 500;
        }

        .control-btn:hover, .tab:hover {
            background: var(--item-hover-bg);
            color: #ffffff;
            border-color: #fff;
            z-index: 10;
        }

        .control-btn.active, .tab.active {
            background: rgba(79, 70, 229, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Tab Specifics */
        .tab {
            width: auto;
            min-width: 120px;
            padding: 0 12px;
            gap: 8px;
            max-width: 200px;
        }
        .tab img {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .tab .tab-icon {
            font-size: 14px;
        }
        .tab span {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* URL Bar */
        #urlbar {
            background-color: #0d0d0d;
            border: 1px solid var(--item-border);
            color: var(--text-main);
            height: var(--control-size);
            border-radius: var(--radius);
            padding: 0 16px;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
            outline: none;
        }
        #urlbar:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
        }

        /* Iframe */
        iframe.viewframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
            background: #fff;
        }
        iframe.viewframe.active { display: block; }
        
        /* Loader */
        #loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            z-index: 50;
            pointer-events: none;
        }
        #loader.hidden { display: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Custom Modal (Styled like notes/velium) */
        #custom-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #custom-modal.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: #0d0d0d; 
            border: 1px solid #333; 
            padding: 0;
            border-radius: 1rem; 
            width: 90%; max-width: 400px;
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.95); transition: transform 0.2s;
            overflow: hidden;
        }
        #custom-modal.active .modal-content { transform: scale(1); }
        
        .modal-header {
            padding: 1.25rem; border-bottom: 1px solid #333;
            background: #040404;
        }
        .modal-title { font-size: 1.1rem; color: #fff; font-weight: 500; }
        
        .modal-body-container { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }

        .modal-input {
            background: #111; border: 1px solid #333; padding: 0.75rem;
            border-radius: 0.5rem; color: #c0c0c0; outline: none; width: 100%; transition: all 0.2s;
        }
        .modal-input:focus { border-color: #555; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        
        .modal-btn {
            padding: 0.5rem 1rem; border-radius: 0.75rem; cursor: pointer; font-size: 0.9rem; font-weight: 500;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .modal-btn.cancel { background: transparent; color: #9ca3af; border: 1px solid transparent; }
        .modal-btn.cancel:hover { color: #fff; background: #222; border-color: #333; }
        
        .modal-btn.confirm { 
            background: rgba(79, 70, 229, 0.1); color: #4f46e5; border: 1px solid #4f46e5; 
        }
        .modal-btn.confirm:hover { 
            background: rgba(79, 70, 229, 0.15); border-color: #6366f1; color: #6366f1; 
        }

        /* --- Notifications --- */
        #notification-container { position: fixed; bottom: 2rem; right: 2rem; display: flex; flex-direction: column; gap: 0.75rem; z-index: 1000; pointer-events: none; }
        .notification-toast { background-color: #0a0a0a; border: 1px solid #333; border-radius: 14px; padding: 0.75rem 1.25rem; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; min-width: 200px; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease, background-color 0.2s; opacity: 0; pointer-events: auto; cursor: default; }
        .notification-toast.show { transform: translateX(0); opacity: 1; }
        .notification-toast.show:hover { transform: scale(1.05) translateX(-5px); background-color: #151515; border-color: #555; box-shadow: 0 8px 25px rgba(0,0,0,0.7); }
        .notification-icon { font-size: 1.1rem; }
        .notification-icon.success { color: #4ade80; }
        .notification-icon.info { color: #60a5fa; }
        .notification-icon.warning { color: #fbbf24; }

    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Custom Modal -->
    <div id="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Title</div>
            </div>
            <div class="modal-body-container">
                <div id="modal-body"></div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" id="modal-cancel">Cancel</button>
                    <button class="modal-btn confirm" id="modal-confirm">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Toolbar -->
    <header class="flex items-center p-3 gap-3 shrink-0 relative z-20">
        <div class="flex items-center gap-2">
            <button onclick="b()" class="control-btn" title="Back"><i class="fas fa-chevron-left"></i></button>
            <button onclick="f()" class="control-btn" title="Forward"><i class="fas fa-chevron-right"></i></button>
            <button onclick="r()" class="control-btn" title="Reload"><i class="fas fa-rotate-right"></i></button>
             <button onclick="newTab()" class="control-btn" title="New Tab"><i class="fas fa-plus"></i></button>
        </div>
        <form id="form" class="flex-grow">
            <input type="text" id="urlbar" placeholder="Search or enter URL">
        </form>
        <div class="flex items-center gap-2">
             <button onclick="pinCurrent()" class="control-btn" title="Pin Current Page"><i class="fas fa-thumbtack"></i></button>
             <button onclick="fullscreen()" class="control-btn" title="Fullscreen"><i class="fas fa-expand"></i></button>
        </div>
    </header>

    <!-- Mini Bar (Tabs/Pins) -->
    <div id="mini-bar" class="flex items-center px-3 pb-2 gap-2 shrink-0 border-b border-[#333] bg-[#040404] relative z-10 pt-2">
        <!-- Toggle Button -->
        <button id="view-toggle" onclick="toggleView()" class="control-btn" title="Switch View" style="width: 42px; padding: 0;">
            <i class="fas fa-layer-group transition-all duration-300" id="toggle-icon"></i>
        </button>

        <!-- Scrollable Area -->
        <div class="flex-grow overflow-hidden relative h-[44px]" id="scroll-wrapper">
             <!-- Tabs List -->
             <div id="tabs-bar" class="flex items-center gap-2 absolute inset-0 transition-all duration-300 overflow-x-auto no-scrollbar whitespace-nowrap px-1">
                <!-- Tabs injected here -->
             </div>
             <!-- Pins List -->
             <div id="pins-bar" class="flex items-center gap-2 absolute inset-0 transition-all duration-300 overflow-x-auto no-scrollbar whitespace-nowrap px-1 opacity-0 pointer-events-none translate-y-[-10px]">
                <!-- Pins injected here -->
             </div>
        </div>

        <!-- Scroll Button -->
        <button id="scroll-btn" onclick="scrollRight()" class="control-btn hidden" style="width: 42px; padding: 0;">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div id="iframe-container" class="flex-grow relative bg-[#111] overflow-hidden">
        <div id="loader" class="hidden">
             <i class="fa-solid fa-spinner fa-spin fa-2x text-white"></i>
        </div>
    </div>

    <script>
        // --- Modal System ---
        const Modal = {
            el: document.getElementById('custom-modal'),
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            cancelBtn: document.getElementById('modal-cancel'),
            confirmBtn: document.getElementById('modal-confirm'),
            
            show(title, content, type = 'confirm') { // type: alert, confirm, prompt, prompt2
                return new Promise((resolve) => {
                    this.title.textContent = title;
                    this.body.innerHTML = '';
                    
                    let input1, input2;
                    
                    if (type === 'prompt' || type === 'prompt2') {
                        input1 = document.createElement('input');
                        input1.className = 'modal-input';
                        input1.placeholder = content.placeholder1 || '';
                        input1.value = content.value1 || '';
                        this.body.appendChild(input1);
                        setTimeout(() => input1.focus(), 50);
                    }
                    if (type === 'prompt2') {
                        input2 = document.createElement('input');
                        input2.className = 'modal-input';
                        input2.placeholder = content.placeholder2 || '';
                        input2.style.marginTop = '10px';
                        this.body.appendChild(input2);
                    }
                    if (type === 'alert' || type === 'confirm') {
                        const p = document.createElement('p');
                        p.textContent = content;
                        p.style.color = '#c0c0c0';
                        this.body.appendChild(p);
                    }

                    this.cancelBtn.style.display = type === 'alert' ? 'none' : 'block';
                    
                    const close = (val) => {
                        this.el.classList.remove('active');
                        this.confirmBtn.onclick = null;
                        this.cancelBtn.onclick = null;
                        this.el.onclick = null;
                        resolve(val);
                    };

                    this.confirmBtn.onclick = () => {
                        if (type === 'prompt') close(input1.value);
                        else if (type === 'prompt2') close({ val1: input1.value, val2: input2.value });
                        else close(true);
                    };
                    
                    this.cancelBtn.onclick = () => close(type === 'confirm' ? false : null);

                    // Close on background click
                    this.el.onclick = (e) => {
                        if(e.target === this.el && type !== 'alert') close(null);
                    };
                    
                    this.el.classList.add('active');
                });
            },
            
            async alert(msg) { return this.show('Alert', msg, 'alert'); },
            async confirm(msg) { return this.show('Confirm', msg, 'confirm'); },
            async prompt(title, placeholder, def = '') { return this.show(title, {placeholder1: placeholder, value1: def}, 'prompt'); },
            async promptDouble(title, ph1, ph2) { return this.show(title, {placeholder1: ph1, placeholder2: ph2}, 'prompt2'); }
        };

        // --- Configuration ---
        // Immediate Initialization
        (async () => {
            if ("serviceWorker" in navigator) {
                // Register SW immediately, don't wait for window load
                try {
                    await navigator.serviceWorker.register(__uv$config.stockSW, {
                        scope: __uv$config.prefix
                    });
                    console.log("SW Registered Fast");
                } catch (e) {
                    console.error("SW Register Failed", e);
                }
            }

            // Init BareMux
            try {
                const connection = new BareMux.BareMuxConnection("/VERN/baremux/worker.js");
                const wispUrl = "wss://wisp.rhw.one/";
                connection.setTransport("/VERN/libcurl/index.mjs", [{ websocket: wispUrl }]);
            } catch (e) {
                console.error("BareMux Init Failed", e);
            }
        })();

        // --- State ---
        let bTabs = [];
        let aTab = 0;
        let tabCounter = 1;
        const HOMEPAGE_URL = "vern://newtab";
        
        let viewMode = 'tabs'; // 'tabs' or 'pins'

        // --- Mini Bar Logic ---
        function toggleView() {
            const tabsBar = document.getElementById("tabs-bar");
            const pinsBar = document.getElementById("pins-bar");
            const icon = document.getElementById("toggle-icon");
            
            if (viewMode === 'tabs') {
                viewMode = 'pins';
                // Switch to Pins
                tabsBar.classList.add("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                pinsBar.classList.remove("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                icon.classList.remove("fa-layer-group");
                icon.classList.add("fa-thumbtack");
                renderPinsInBar();
            } else {
                viewMode = 'tabs';
                // Switch to Tabs
                pinsBar.classList.add("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                tabsBar.classList.remove("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                icon.classList.remove("fa-thumbtack");
                icon.classList.add("fa-layer-group");
            }
            checkScroll();
        }

        function checkScroll() {
            const container = viewMode === 'tabs' ? document.getElementById("tabs-bar") : document.getElementById("pins-bar");
            const btn = document.getElementById("scroll-btn");
            if (container.scrollWidth > container.clientWidth) {
                btn.classList.remove("hidden");
            } else {
                btn.classList.add("hidden");
            }
        }
        
        // Listen for resize to update scroll button visibility
        window.addEventListener('resize', checkScroll);

        function scrollRight() {
            const container = viewMode === 'tabs' ? document.getElementById("tabs-bar") : document.getElementById("pins-bar");
            const shift = (42 + 8) * 5; // 5 tabs (width + gap)
            container.scrollBy({ left: shift, behavior: 'smooth' });
        }

        // --- Pinning ---
        function getPins() {
            return JSON.parse(localStorage.getItem("vern_pins") || "[]");
        }
        async function addPin(title, url, icon) {
            const pins = getPins();
            if(pins.length >= 10) { await Modal.alert("Max 10 pins allowed."); return; }
            if(pins.some(p => p.url === url)) return;
            pins.push({ title, url, icon });
            localStorage.setItem("vern_pins", JSON.stringify(pins));
            refreshHomepage();
            if(viewMode === 'pins') renderPinsInBar();
        }
        function removePin(url) {
            const pins = getPins().filter(p => p.url !== url);
            localStorage.setItem("vern_pins", JSON.stringify(pins));
            refreshHomepage();
            if(viewMode === 'pins') renderPinsInBar();
        }
        async function pinCurrent() {
            const cTab = bTabs.find(t => t.id === aTab);
            if (!cTab || cTab.url === HOMEPAGE_URL) return;
            const frame = document.querySelector(`.viewframe[data-frame-id="${aTab}"]`);
            const title = (frame && frame.contentDocument && frame.contentDocument.title) || cTab.title || "Page";
            let realUrl = cTab.url;
            try {
                 if (realUrl.includes(__uv$config.prefix)) {
                     realUrl = __uv$config.decodeUrl(realUrl.split(__uv$config.prefix)[1]);
                 }
            } catch(e){}
            let icon = `https://www.google.com/s2/favicons?domain=${realUrl}&sz=128`;
            
            addPin(title, realUrl, icon);
            await Modal.alert("Page pinned to New Tab!");
        }

        function renderPinsInBar() {
            const container = document.getElementById("pins-bar");
            container.innerHTML = "";
            getPins().forEach(p => {
                const el = document.createElement("div");
                el.className = "tab";
                el.title = p.title;
                el.innerHTML = `<img src="${p.icon}" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/svgs/solid/globe.svg'">
                                <span>${p.title}</span>`;
                el.onclick = (e) => {
                     nav(p.url);
                };
                el.oncontextmenu = async (e) => {
                    e.preventDefault();
                    if(await Modal.confirm("Remove this pin?")) removePin(p.url);
                };
                container.appendChild(el);
            });
            checkScroll();
        }

        // --- Suggestions & Homepage ---
        window.fetchSuggestions = async (query) => {
            if (!query) return [];
            try {
                // Google's autocomplete API (client=chrome returns simple JSON)
                const url = `https://suggestqueries.google.com/complete/search?client=chrome&q=${encodeURIComponent(query)}`;
                
                // Use your existing UV proxy to bypass CORS
                const proxyUrl = (window.__uv$config) ? __uv$config.prefix + __uv$config.encodeUrl(url) : url;
                
                const res = await fetch(proxyUrl);
                const data = await res.json();
                
                // Google's format: [query, [suggestion1, suggestion2, ...], ...]
                return data[1] || [];
            } catch (e) { 
                console.error("Suggestion error:", e);
                return []; 
            }
        };

        function refreshHomepage() {
             const frame = document.querySelector(`.viewframe[data-frame-id="${aTab}"]`);
             if (frame && bTabs.find(t => t.id === aTab).url === HOMEPAGE_URL) {
                 frame.srcdoc = getHomepageHTML();
             }
        }

        function getHomepageHTML() {
            const pins = getPins();
            // Note: Avoiding nested backticks by using string concat for inner JS
            const pinsHtml = pins.map(p => `
                <div class="pin-card" oncontextmenu="event.preventDefault(); window.parent.removePinPrompt('${p.url}')" onclick="window.parent.nav('${p.url}')">
                    <img src="${p.icon}" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/svgs/solid/globe.svg'">
                    <span>${p.title}</span>
                </div>
            `).join('');

            return `
            <!DOCTYPE html>
            <html class="dark">
            <head>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
            <link rel="icon" href="/images/logo.png">
            <style>
                body { background: #040404; color: #e5e7eb; font-family: 'Geist', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; position: relative; }
                .container { width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; gap: 30px; z-index: 10; align-items: center; }
                
                /* Logo / Branding - Centered above search */
                .brand-center { 
                    display: flex; align-items: center; justify-content: center; gap: 15px; 
                    margin-bottom: 10px;
                }
                .brand-center img { width: 48px; height: 48px; }
                .brand-center h1 { font-size: 3rem; font-weight: 300; letter-spacing: 2px; margin: 0; color: #fff; font-style: italic; }

                .search-box { position: relative; width: 100%; }
                input { 
                    width: 100%; background: #0d0d0d; border: 1px solid #333; padding: 16px 24px; border-radius: 1.5rem; /* Matches navigation.js style */
                    color: white; outline: none; font-size: 1.1rem; transition: all 0.2s; 
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                }
                input:focus { border-color: #4f46e5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15); transform: scale(1.01); }
                
                .suggestions {
                    position: absolute; top: 100%; left: 0; right: 0; background: #0d0d0d; border: 1px solid #333;
                    border-radius: 1rem; margin-top: 8px; max-height: 200px; overflow-y: auto; z-index: 20;
                    display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                }
                .suggestions div { padding: 12px 20px; cursor: pointer; color: #d1d5db; transition: background 0.1s; }
                .suggestions div:hover { background: rgba(79, 70, 229, 0.1); color: #fff; }
                
                .pins-grid { display: grid; grid-template-columns: repeat(5, 80px); gap: 16px; justify-content: center; width: 100%; }
                .pin-card { 
                    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; 
                    padding: 10px; border-radius: 1rem; transition: all 0.2s; position: relative; width: 80px;
                }
                .pin-card:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); }
                .pin-card img { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; background: #222; border: 1px solid #333; }
                .pin-card span { font-size: 0.75rem; color: #9ca3af; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
                
                .add-pin-btn {
                    width: 48px; height: 48px; border-radius: 12px; background: #0d0d0d; 
                    display: flex; align-items: center; justify-content: center; color: #555; 
                    border: 1px solid #333; transition: all 0.2s;
                }
                .pin-card:hover .add-pin-btn { border-color: #4f46e5; color: #4f46e5; background: rgba(79, 70, 229, 0.1); }

            </style>
            </head>
            <body>
                <div class="container">
                    <div class="brand-center">
                        <img src="/images/logo.png" alt="Logo"> 
                        <h1>VERN</h1>
                    </div>

                    <div class="search-box">
                        <form onsubmit="event.preventDefault(); window.parent.nav(this.querySelector('input').value)">
                            <input type="text" id="s-input" placeholder="Search or type a URL..." autocomplete="off">
                        </form>
                        <div id="s-list" class="suggestions"></div>
                    </div>
                    <div class="pins-grid">
                        ${pinsHtml}
                        <div class="pin-card" onclick="window.parent.addPinPrompt()" style="${pins.length >= 10 ? 'display:none' : ''}">
                            <div class="add-pin-btn"><i class="fas fa-plus"></i></div>
                            <span>Add</span>
                        </div>
                    </div>
                </div>
                <script>
                    document.getElementById('s-input').focus();
                    const inp = document.getElementById('s-input');
                    const list = document.getElementById('s-list');
                    let debounce;

                    inp.addEventListener('input', (e) => {
                        const val = e.target.value.trim();
                        if (!val) { list.style.display = 'none'; return; }
                        clearTimeout(debounce);
                        
                        debounce = setTimeout(async () => {
                            // This calls the updated function from the parent window
                            const sugs = await window.parent.fetchSuggestions(val);
                            
                            if (sugs && sugs.length) {
                                // Map the array strings into clickable divs
                                list.innerHTML = sugs.map(s => '<div>' + s + '</div>').join('');
                                list.style.display = 'block';
                                
                                list.querySelectorAll('div').forEach(d => {
                                    d.onclick = () => {
                                        inp.value = d.textContent;
                                        window.parent.nav(d.textContent);
                                        list.style.display = 'none';
                                    }
                                });
                            } else { 
                                list.style.display = 'none'; 
                            }
                        }, 150); // Reduced delay for snappier feel
                    });

                    document.body.addEventListener('click', (e) => { 
                        if (e.target !== inp) list.style.display = 'none'; 
                    });
                <\/script>
            </body>
            </html>
            `;
        }

        // --- Core Functions ---

        // Exposed functions for Homepage
        window.addPinPrompt = async () => {
            const url = await Modal.prompt("Add Pin", "Enter URL to pin");
            if(url) {
                const name = await Modal.prompt("Add Pin", "Enter name (optional)", url) || url;
                const icon = 'https://www.google.com/s2/favicons?domain=' + url + '&sz=128';
                addPin(name, url, icon);
            }
        };

        window.removePinPrompt = async (url) => {
             if(await Modal.confirm('Remove this pin?')) {
                 removePin(url);
             }
        };

        // --- Tab Management ---
        function newTab(urlToLoad = HOMEPAGE_URL) {
            const nTab = { id: tabCounter++, title: "New Tab", url: urlToLoad, history: [], historyIndex: -1 };
            bTabs.push(nTab);

            const tabEl = document.createElement("div");
            tabEl.className = "tab";
            tabEl.dataset.tabId = nTab.id;
            tabEl.title = "New Tab";
            // Show title next to icon
            tabEl.innerHTML = `
                <i class="fas fa-compass tab-icon" id="def-fav-${nTab.id}" style="display:none"></i>
                <img id="fav-${nTab.id}" src="/images/logo.png" style="display:block">
                <span class="tab-title">New Tab</span>
            `;
            
            // Interaction: Left click to switch, Right click to close
            tabEl.addEventListener("click", (e) => { 
                switchTab(nTab.id); 
            });
            tabEl.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                closeTab(nTab.id);
            });

            document.getElementById("tabs-bar").appendChild(tabEl);
            checkScroll();

            const frame = document.createElement("iframe");
            frame.className = "viewframe";
            frame.dataset.frameId = nTab.id;
            document.getElementById("iframe-container").appendChild(frame);

            switchTab(nTab.id);
            navigateFrame(nTab.id, urlToLoad);
        }

        function switchTab(tId) {
            aTab = tId;
            document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", parseInt(t.dataset.tabId) === tId));
            document.querySelectorAll(".viewframe").forEach(f => f.classList.toggle("active", parseInt(f.dataset.frameId) === tId));
            const cTab = bTabs.find(t => t.id === tId);
            updateUrlBar(cTab ? cTab.url : "");
        }

        function closeTab(tId, e) {
            if (e) e.stopPropagation();
            if (bTabs.length <= 1) return;
            const idx = bTabs.findIndex(t => t.id === tId);
            if (idx === -1) return;

            bTabs.splice(idx, 1);
            document.querySelector(`.tab[data-tab-id="${tId}"]`).remove();
            document.querySelector(`.viewframe[data-frame-id="${tId}"]`).remove();
            checkScroll();

            if (aTab === tId) {
                const newTab = bTabs[Math.max(0, idx - 1)];
                switchTab(newTab.id);
            }
        }

        function updateUrlBar(url) {
            const bar = document.getElementById("urlbar");
            if (url === HOMEPAGE_URL) {
                bar.value = ""; bar.placeholder = "Search or enter URL";
            } else {
                try {
                    if (url.includes(__uv$config.prefix)) {
                        url = __uv$config.decodeUrl(url.split(__uv$config.prefix)[1]);
                    }
                } catch(e){}
                bar.value = url;
            }
        }

        async function navigateFrame(tId, url) {
            const frame = document.querySelector(`.viewframe[data-frame-id="${tId}"]`);
            const tabEl = document.querySelector(`.tab[data-tab-id="${tId}"]`);
            const cTab = bTabs.find(t => t.id === tId);
            if (!frame || !cTab) return;

            cTab.url = url;
            updateUrlBar(url);
            
            if (url === HOMEPAGE_URL) {
                frame.src = "";
                frame.srcdoc = getHomepageHTML();
                if (tabEl) {
                     const img = tabEl.querySelector('img');
                     const icon = tabEl.querySelector('.tab-icon');
                     img.src = '/images/logo.png';
                     img.style.display = 'block';
                     icon.style.display = 'none';
                     
                     tabEl.title = "New Tab";
                     tabEl.querySelector('.tab-title').textContent = "New Tab";
                }
                return;
            }

            let finalUrl = url;
            if (!url.startsWith(__uv$config.prefix)) finalUrl = __uv$config.prefix + __uv$config.encodeUrl(url);

            frame.removeAttribute('srcdoc');
            frame.src = finalUrl;

            try {
                let realUrl = url.includes(__uv$config.prefix) ? __uv$config.decodeUrl(url.split(__uv$config.prefix)[1]) : url;
                if (tabEl) {
                    const img = tabEl.querySelector('img');
                    const icon = tabEl.querySelector('.tab-icon');
                    img.src = `https://www.google.com/s2/favicons?domain=${realUrl}&sz=64`;
                    img.style.display = 'block';
                    icon.style.display = 'none';
                }
            } catch(e){}

            frame.onload = () => {
                try {
                    const title = frame.contentDocument.title;
                    if (title && tabEl) {
                        tabEl.title = title;
                        tabEl.querySelector('.tab-title').textContent = title;
                    }
                    
                    const loc = frame.contentWindow.location.href;
                    if (loc && loc.includes(__uv$config.prefix)) {
                        cTab.url = loc;
                        updateUrlBar(loc);
                    }

                    const win = frame.contentWindow;
                    win.open = (u, t) => { window.newTab(u); return null; };
                    win.document.body.addEventListener('click', (e) => {
                        const link = e.target.closest('a');
                        if (link && link.target === '_blank') {
                            e.preventDefault();
                            window.newTab(link.href);
                        }
                    });
                } catch(e) {}
            };
        }

        document.getElementById("form").addEventListener("submit", (e) => {
            e.preventDefault();
            nav(document.getElementById("urlbar").value.trim());
        });

        function nav(val) {
             if (!val) return;
             let url = val;
             if (!url.startsWith('http') && !url.includes('.')) url = "https://duckduckgo.com/?q=" + encodeURIComponent(val);
             else if (!url.startsWith('http')) url = "https://" + url;
             navigateFrame(aTab, url);
        }

        newTab();
        window.nav = nav;
        window.addPin = addPin;
        window.removePin = removePin;

        function b() { document.querySelector(`.viewframe[data-frame-id="${aTab}"]`)?.contentWindow.history.back(); }
        function f() { document.querySelector(`.viewframe[data-frame-id="${aTab}"]`)?.contentWindow.history.forward(); }
        function r() { document.querySelector(`.viewframe[data-frame-id="${aTab}"]`)?.contentWindow.location.reload(); }
        function fullscreen() { 
             const frame = document.querySelector(`.viewframe[data-frame-id="${aTab}"]`);
             if (frame) {
                 if (frame.requestFullscreen) {
                     frame.requestFullscreen();
                 } else if (frame.webkitRequestFullscreen) { /* Safari */
                     frame.webkitRequestFullscreen();
                 } else if (frame.msRequestFullscreen) { /* IE11 */
                     frame.msRequestFullscreen();
                 }
             }
        }

    </script>    <!-- DB and Script -->
    <script src="db.js" defer></script>
    <script src="script.js" defer></script>

    <div id="notification-container"></div>
    <script>
    // --- Sound & Notification Logic ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = false;

    function playClickSound() {
        if (isMuted) return; if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.015);
        osc.start(); osc.stop(audioCtx.currentTime + 0.015);
    }

    const notificationContainer = document.getElementById('notification-container');
    window.showNotification = function(message, iconClass = 'fa-solid fa-info-circle', type = 'info') {
        if (!notificationContainer) return;
        while (notificationContainer.children.length >= 3) notificationContainer.removeChild(notificationContainer.firstChild);
        const toast = document.createElement('div'); toast.className = 'notification-toast';
        toast.innerHTML = `<i class="${iconClass} notification-icon ${type}"></i><span>${message}</span>`;
        notificationContainer.appendChild(toast);
        requestAnimationFrame(() => { toast.classList.add('show'); playClickSound(); });
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (toast.parentElement) toast.remove(); }, 300); }, 3000);
    };
    
    // Override alert to use notification
    window.alert = function(message) {
        window.showNotification(message, 'fa-solid fa-bell', 'info');
    };
    </script>
</body>
</html>
