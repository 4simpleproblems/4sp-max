<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVIUM</title>
    
    <script src="/LEVIUM/uv/uv.bundle.js"></script>
    <script src="/LEVIUM/uv/uv.config.js"></script>
    <script src="/LEVIUM/baremux/index.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-color: #040404;
            --toolbar-bg: #0a0a0a;
            --item-bg: #1a1a1a;
            --item-border: #333;
            --item-hover-bg: #2a2a2a;
            --accent: #4f46e5;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --radius: 12px;
            --control-size: 42px;
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-muted); 
            transition: all 0.3s ease;
            font-size: 14px;
            overflow: hidden;
            font-weight: 400;
        }

        /* Toolbar Container */
        header {
            background-color: var(--toolbar-bg);
            border-bottom: 1px solid var(--item-border);
        }

        /* Common Control Style */
        .control-btn, .tab {
            width: var(--control-size);
            height: var(--control-size);
            border-radius: var(--radius);
            background: var(--item-bg);
            border: 1px solid var(--item-border);
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
        }

        .control-btn:hover, .tab:hover {
            background: var(--item-hover-bg);
            color: var(--text-main);
            border-color: #555;
        }

        .control-btn.active, .tab.active {
            background: rgba(79, 70, 229, 0.15);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Tab Specifics */
        .tab {
            width: auto;
            min-width: var(--control-size);
            padding: 0 10px;
            gap: 8px;
            max-width: 200px;
        }
        .tab img {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .tab .tab-icon {
            font-size: 14px;
        }
        .tab span {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Close Button Overlay (Hidden, now right click) */
        .tab .close-overlay {
            display: none; 
        }

        /* URL Bar */
        #urlbar {
            background-color: var(--item-bg);
            border: 1px solid var(--item-border);
            color: var(--text-main);
            height: var(--control-size);
            border-radius: var(--radius);
            padding: 0 16px;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
        }
        #urlbar:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
            outline: none;
        }

        /* Iframe */
        iframe.viewframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
            background: #fff;
        }
        iframe.viewframe.active { display: block; }
        
        /* Loader */
        #loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            z-index: 50;
            pointer-events: none;
        }
        #loader.hidden { display: none; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mini Bar Transitions */
        .fade-enter { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .fade-exit { opacity: 0; pointer-events: none; transform: translateY(-10px); }

        /* Custom Modal */
        #custom-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #custom-modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: #1a1a1a; border: 1px solid #333; padding: 20px;
            border-radius: 16px; width: 90%; max-width: 400px;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transform: scale(0.95); transition: transform 0.2s;
        }
        #custom-modal.active .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.1rem; color: #fff; font-weight: 500; }
        .modal-input {
            background: #111; border: 1px solid #333; padding: 10px;
            border-radius: 8px; color: #fff; outline: none; width: 100%;
        }
        .modal-input:focus { border-color: #4f46e5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        .modal-btn {
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .modal-btn.cancel { background: transparent; color: #9ca3af; }
        .modal-btn.cancel:hover { color: #fff; background: #222; }
        .modal-btn.confirm { background: #4f46e5; color: white; }
        .modal-btn.confirm:hover { background: #4338ca; }

    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Custom Modal -->
    <div id="custom-modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-title">Title</div>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="modal-cancel">Cancel</button>
                <button class="modal-btn confirm" id="modal-confirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Main Toolbar -->
    <header class="flex items-center p-3 gap-3 shrink-0 relative z-20">
        <div class="flex items-center gap-2">
            <button onclick="b()" class="control-btn" title="Back"><i class="fas fa-chevron-left"></i></button>
            <button onclick="f()" class="control-btn" title="Forward"><i class="fas fa-chevron-right"></i></button>
            <button onclick="r()" class="control-btn" title="Reload"><i class="fas fa-rotate-right"></i></button>
             <button onclick="newTab()" class="control-btn" title="New Tab"><i class="fas fa-plus"></i></button>
        </div>
        <form id="form" class="flex-grow">
            <input type="text" id="urlbar" placeholder="Search or enter URL">
        </form>
        <div class="flex items-center gap-2">
             <button onclick="pinCurrent()" class="control-btn" title="Pin Current Page"><i class="fas fa-thumbtack"></i></button>
             <button onclick="full()" class="control-btn" title="Open in New Window"><i class="fas fa-external-link"></i></button>
        </div>
    </header>

    <!-- Mini Bar (Tabs/Pins) -->
    <div id="mini-bar" class="flex items-center px-3 pb-2 gap-2 shrink-0 border-b border-[#1a1a1a] bg-[#040404] relative z-10 pt-2">
        <!-- Toggle Button -->
        <button id="view-toggle" onclick="toggleView()" class="control-btn" title="Switch View" style="width: 42px;">
            <i class="fas fa-layer-group transition-all duration-300" id="toggle-icon"></i>
        </button>

        <!-- Scrollable Area -->
        <div class="flex-grow overflow-hidden relative h-[44px]" id="scroll-wrapper">
             <!-- Tabs List -->
             <div id="tabs-bar" class="flex items-center gap-2 absolute inset-0 transition-all duration-300 overflow-x-auto no-scrollbar whitespace-nowrap px-1">
                <!-- Tabs injected here -->
             </div>
             <!-- Pins List -->
             <div id="pins-bar" class="flex items-center gap-2 absolute inset-0 transition-all duration-300 overflow-x-auto no-scrollbar whitespace-nowrap px-1 opacity-0 pointer-events-none translate-y-[-10px]">
                <!-- Pins injected here -->
             </div>
        </div>

        <!-- Scroll Button -->
        <button id="scroll-btn" onclick="scrollRight()" class="control-btn hidden" style="width: 42px;">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div id="iframe-container" class="flex-grow relative bg-[#111] overflow-hidden">
        <div id="loader" class="hidden">
             <i class="fa-solid fa-spinner fa-spin fa-2x text-white"></i>
        </div>
    </div>

    <script>
        // --- Modal System ---
        const Modal = {
            el: document.getElementById('custom-modal'),
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            cancelBtn: document.getElementById('modal-cancel'),
            confirmBtn: document.getElementById('modal-confirm'),
            
            show(title, content, type = 'confirm') { // type: alert, confirm, prompt, prompt2
                return new Promise((resolve) => {
                    this.title.textContent = title;
                    this.body.innerHTML = '';
                    
                    let input1, input2;
                    
                    if (type === 'prompt' || type === 'prompt2') {
                        input1 = document.createElement('input');
                        input1.className = 'modal-input';
                        input1.placeholder = content.placeholder1 || '';
                        input1.value = content.value1 || '';
                        this.body.appendChild(input1);
                        setTimeout(() => input1.focus(), 50);
                    }
                    if (type === 'prompt2') {
                        input2 = document.createElement('input');
                        input2.className = 'modal-input';
                        input2.placeholder = content.placeholder2 || '';
                        input2.style.marginTop = '10px';
                        this.body.appendChild(input2);
                    }
                    if (type === 'alert' || type === 'confirm') {
                        const p = document.createElement('p');
                        p.textContent = content;
                        p.style.color = '#ccc';
                        this.body.appendChild(p);
                    }

                    this.cancelBtn.style.display = type === 'alert' ? 'none' : 'block';
                    
                    const close = (val) => {
                        this.el.classList.remove('active');
                        this.confirmBtn.onclick = null;
                        this.cancelBtn.onclick = null;
                        this.el.onclick = null;
                        resolve(val);
                    };

                    this.confirmBtn.onclick = () => {
                        if (type === 'prompt') close(input1.value);
                        else if (type === 'prompt2') close({ val1: input1.value, val2: input2.value });
                        else close(true);
                    };
                    
                    this.cancelBtn.onclick = () => close(type === 'confirm' ? false : null);

                    // Close on background click
                    this.el.onclick = (e) => {
                        if(e.target === this.el && type !== 'alert') close(null);
                    };
                    
                    this.el.classList.add('active');
                });
            },
            
            async alert(msg) { return this.show('Alert', msg, 'alert'); },
            async confirm(msg) { return this.show('Confirm', msg, 'confirm'); },
            async prompt(title, placeholder, def = '') { return this.show(title, {placeholder1: placeholder, value1: def}, 'prompt'); },
            async promptDouble(title, ph1, ph2) { return this.show(title, {placeholder1: ph1, placeholder2: ph2}, 'prompt2'); }
        };

        // --- Configuration ---
        const connection = new BareMux.BareMuxConnection("/LEVIUM/baremux/worker.js");
        const wispUrl = "wss://wisp.rhw.one/";
        connection.setTransport("/LEVIUM/libcurl/index.mjs", [{ websocket: wispUrl }]);

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register(__uv$config.stockSW, {
                    scope: __uv$config.prefix
                });
            });
        }

        // --- State ---
        let bTabs = [];
        let aTab = 0;
        let tabCounter = 1;
        const HOMEPAGE_URL = "levium://newtab";
        
        let viewMode = 'tabs'; // 'tabs' or 'pins'

        // --- Mini Bar Logic ---
        function toggleView() {
            const tabsBar = document.getElementById("tabs-bar");
            const pinsBar = document.getElementById("pins-bar");
            const icon = document.getElementById("toggle-icon");
            
            if (viewMode === 'tabs') {
                viewMode = 'pins';
                // Switch to Pins
                tabsBar.classList.add("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                pinsBar.classList.remove("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                icon.classList.remove("fa-layer-group");
                icon.classList.add("fa-thumbtack");
                renderPinsInBar();
            } else {
                viewMode = 'tabs';
                // Switch to Tabs
                pinsBar.classList.add("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                tabsBar.classList.remove("opacity-0", "pointer-events-none", "translate-y-[-10px]");
                icon.classList.remove("fa-thumbtack");
                icon.classList.add("fa-layer-group");
            }
            checkScroll();
        }

        function checkScroll() {
            const container = viewMode === 'tabs' ? document.getElementById("tabs-bar") : document.getElementById("pins-bar");
            const btn = document.getElementById("scroll-btn");
            if (container.scrollWidth > container.clientWidth) {
                btn.classList.remove("hidden");
            } else {
                btn.classList.add("hidden");
            }
        }
        
        // Listen for resize to update scroll button visibility
        window.addEventListener('resize', checkScroll);

        function scrollRight() {
            const container = viewMode === 'tabs' ? document.getElementById("tabs-bar") : document.getElementById("pins-bar");
            const shift = (42 + 8) * 5; // 5 tabs (width + gap)
            container.scrollBy({ left: shift, behavior: 'smooth' });
        }

        // --- Pinning ---
        function getPins() {
            return JSON.parse(localStorage.getItem("levium_pins") || "[]");
        }
        async function addPin(title, url, icon) {
            const pins = getPins();
            if(pins.length >= 10) { await Modal.alert("Max 10 pins allowed."); return; }
            if(pins.some(p => p.url === url)) return;
            pins.push({ title, url, icon });
            localStorage.setItem("levium_pins", JSON.stringify(pins));
            refreshHomepage();
            if(viewMode === 'pins') renderPinsInBar();
        }
        function removePin(url) {
            const pins = getPins().filter(p => p.url !== url);
            localStorage.setItem("levium_pins", JSON.stringify(pins));
            refreshHomepage();
            if(viewMode === 'pins') renderPinsInBar();
        }
        async function pinCurrent() {
            const cTab = bTabs.find(t => t.id === aTab);
            if (!cTab || cTab.url === HOMEPAGE_URL) return;
            const frame = document.querySelector(`.viewframe[data-frame-id="${aTab}"]`);
            const title = (frame && frame.contentDocument && frame.contentDocument.title) || cTab.title || "Page";
            let realUrl = cTab.url;
            try {
                 if (realUrl.includes(__uv$config.prefix)) {
                     realUrl = __uv$config.decodeUrl(realUrl.split(__uv$config.prefix)[1]);
                 }
            } catch(e){}
            let icon = `https://www.google.com/s2/favicons?domain=${realUrl}&sz=128`;
            
            addPin(title, realUrl, icon);
            await Modal.alert("Page pinned to New Tab!");
        }

        function renderPinsInBar() {
            const container = document.getElementById("pins-bar");
            container.innerHTML = "";
            getPins().forEach(p => {
                const el = document.createElement("div");
                el.className = "tab";
                el.title = p.title;
                el.innerHTML = `<img src="${p.icon}" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/svgs/solid/globe.svg'">
                                <span>${p.title}</span>`;
                el.onclick = (e) => {
                     nav(p.url);
                };
                el.oncontextmenu = async (e) => {
                    e.preventDefault();
                    if(await Modal.confirm("Remove this pin?")) removePin(p.url);
                };
                container.appendChild(el);
            });
            checkScroll();
        }

        // --- Suggestions & Homepage ---
        window.fetchSuggestions = async (query) => {
            if (!query) return [];
            try {
                const url = `https://duckduckgo.com/ac/?q=${encodeURIComponent(query)}&type=list`;
                const proxyUrl = (window.__uv$config) ? __uv$config.prefix + __uv$config.encodeUrl(url) : url;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                return data[1] || [];
            } catch (e) { return []; }
        };

        function refreshHomepage() {
             const frame = document.querySelector(`.viewframe[data-frame-id="${aTab}"]`);
             if (frame && bTabs.find(t => t.id === aTab).url === HOMEPAGE_URL) {
                 frame.srcdoc = getHomepageHTML();
             }
        }

        function getHomepageHTML() {
            const pins = getPins();
            // Note: Avoiding nested backticks by using string concat for inner JS
            const pinsHtml = pins.map(p => `
                <div class="pin-card" oncontextmenu="event.preventDefault(); window.parent.removePinPrompt('${p.url}')" onclick="window.parent.nav('${p.url}')">
                    <img src="${p.icon}" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/svgs/solid/globe.svg'">
                    <span>${p.title}</span>
                </div>
            `).join('');

            return `
            <!DOCTYPE html>
            <html class="dark">
            <head>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
            <style>
                body { background: #040404; color: #e5e7eb; font-family: 'Geist', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
                .container { width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; gap: 40px; }
                .brand { display: flex; flex-direction: column; align-items: center; gap: 10px; }
                .brand h1 { font-size: 3rem; font-weight: 300; letter-spacing: -1px; margin: 0; }
                .search-box { position: relative; width: 100%; }
                input { 
                    width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 16px 24px; border-radius: 16px; 
                    color: white; outline: none; font-size: 1.1rem; transition: all 0.2s; 
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                }
                input:focus { border-color: #4f46e5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15); }
                .suggestions {
                    position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333;
                    border-radius: 12px; margin-top: 8px; max-height: 200px; overflow-y: auto; z-index: 10;
                    display: none;
                }
                .suggestions div { padding: 10px 20px; cursor: pointer; color: #d1d5db; }
                .suggestions div:hover { background: #2a2a2a; color: white; }
                .pins-grid { display: grid; grid-template-columns: repeat(5, 80px); gap: 16px; justify-content: center; width: 100%; }
                .pin-card { 
                    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; 
                    padding: 10px; border-radius: 12px; transition: background 0.2s; position: relative; width: 80px;
                }
                .pin-card:hover { background: #1a1a1a; }
                .pin-card img { width: 42px; height: 42px; border-radius: 10px; object-fit: cover; background: #222; }
                .pin-card span { font-size: 0.8rem; color: #9ca3af; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
            </style>
            </head>
            <body>
                <div class="container">
                    <div class="brand">
                        <h1>Levium</h1>
                    </div>
                    <div class="search-box">
                        <form onsubmit="event.preventDefault(); window.parent.nav(this.querySelector('input').value)">
                            <input type="text" id="s-input" placeholder="Search the web..." autocomplete="off">
                        </form>
                        <div id="s-list" class="suggestions"></div>
                    </div>
                    <div class="pins-grid">
                        ${pinsHtml}
                        <div class="pin-card" onclick="window.parent.addPinPrompt()" style="${pins.length >= 10 ? 'display:none' : ''}">
                            <div style="width:42px; height:42px; border-radius:10px; background:#1a1a1a; display:flex; align-items:center; justify-content:center; color:#555"><i class="fas fa-plus"></i></div>
                            <span>Add</span>
                        </div>
                    </div>
                </div>
                <script>
                    document.getElementById('s-input').focus();
                    const inp = document.getElementById('s-input');
                    const list = document.getElementById('s-list');
                    let debounce;
                    inp.addEventListener('input', (e) => {
                        const val = e.target.value.trim();
                        if (!val) { list.style.display = 'none'; return; }
                        clearTimeout(debounce);
                        debounce = setTimeout(async () => {
                            const sugs = await window.parent.fetchSuggestions(val);
                            if (sugs.length) {
                                list.innerHTML = sugs.map(s => '<div>' + s + '</div>').join('');
                                list.style.display = 'block';
                                list.querySelectorAll('div').forEach(d => {
                                    d.onclick = () => {
                                        inp.value = d.textContent;
                                        window.parent.nav(d.textContent);
                                    }
                                });
                            } else { list.style.display = 'none'; }
                        }, 200);
                    });
                    document.body.addEventListener('click', (e) => { if (e.target !== inp) list.style.display = 'none'; });
                <\/script>
            </body>
            </html>
            `;
        }

        // --- Core Functions ---

        // Exposed functions for Homepage
        window.addPinPrompt = async () => {
            const url = await Modal.prompt("Add Pin", "Enter URL to pin");
            if(url) {
                const name = await Modal.prompt("Add Pin", "Enter name (optional)", url) || url;
                const icon = 'https://www.google.com/s2/favicons?domain=' + url + '&sz=128';
                addPin(name, url, icon);
            }
        };

        window.removePinPrompt = async (url) => {
             if(await Modal.confirm('Remove this pin?')) {
                 removePin(url);
             }
        };

        // --- Tab Management ---
        function newTab(urlToLoad = HOMEPAGE_URL) {
            const nTab = { id: tabCounter++, title: "New Tab", url: urlToLoad, history: [], historyIndex: -1 };
            bTabs.push(nTab);

            const tabEl = document.createElement("div");
            tabEl.className = "tab";
            tabEl.dataset.tabId = nTab.id;
            tabEl.title = "New Tab";
            // Show title next to icon
            tabEl.innerHTML = `
                <i class="fas fa-compass tab-icon" id="def-fav-${nTab.id}"></i>
                <img id="fav-${nTab.id}" src="" style="display:none">
                <span class="tab-title">New Tab</span>
            `;
            
            // Interaction: Left click to switch, Right click to close
            tabEl.addEventListener("click", (e) => { 
                switchTab(nTab.id); 
            });
            tabEl.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                closeTab(nTab.id);
            });

            document.getElementById("tabs-bar").appendChild(tabEl);
            checkScroll();

            const frame = document.createElement("iframe");
            frame.className = "viewframe";
            frame.dataset.frameId = nTab.id;
            document.getElementById("iframe-container").appendChild(frame);

            switchTab(nTab.id);
            navigateFrame(nTab.id, urlToLoad);
        }

        function switchTab(tId) {
            aTab = tId;
            document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", parseInt(t.dataset.tabId) === tId));
            document.querySelectorAll(".viewframe").forEach(f => f.classList.toggle("active", parseInt(f.dataset.frameId) === tId));
            const cTab = bTabs.find(t => t.id === tId);
            updateUrlBar(cTab ? cTab.url : "");
        }

        function closeTab(tId, e) {
            if (e) e.stopPropagation();
            if (bTabs.length <= 1) return;
            const idx = bTabs.findIndex(t => t.id === tId);
            if (idx === -1) return;

            bTabs.splice(idx, 1);
            document.querySelector(`.tab[data-tab-id="${tId}"]`).remove();
            document.querySelector(`.viewframe[data-frame-id="${tId}"]`).remove();
            checkScroll();

            if (aTab === tId) {
                const newTab = bTabs[Math.max(0, idx - 1)];
                switchTab(newTab.id);
            }
        }

        function updateUrlBar(url) {
            const bar = document.getElementById("urlbar");
            if (url === HOMEPAGE_URL) {
                bar.value = ""; bar.placeholder = "Search or enter URL";
            } else {
                try {
                    if (url.includes(__uv$config.prefix)) {
                        url = __uv$config.decodeUrl(url.split(__uv$config.prefix)[1]);
                    }
                } catch(e){}
                bar.value = url;
            }
        }

        async function navigateFrame(tId, url) {
            const frame = document.querySelector(`.viewframe[data-frame-id="${tId}"]`);
            const tabEl = document.querySelector(`.tab[data-tab-id="${tId}"]`);
            const cTab = bTabs.find(t => t.id === tId);
            if (!frame || !cTab) return;

            cTab.url = url;
            updateUrlBar(url);
            
            if (url === HOMEPAGE_URL) {
                frame.src = "";
                frame.srcdoc = getHomepageHTML();
                if (tabEl) {
                     tabEl.querySelector('img').style.display = 'none';
                     tabEl.querySelector('.tab-icon').style.display = 'inline-block';
                     tabEl.title = "New Tab";
                     tabEl.querySelector('.tab-title').textContent = "New Tab";
                }
                return;
            }

            let finalUrl = url;
            if (!url.startsWith(__uv$config.prefix)) finalUrl = __uv$config.prefix + __uv$config.encodeUrl(url);

            frame.removeAttribute('srcdoc');
            frame.src = finalUrl;

            try {
                let realUrl = url.includes(__uv$config.prefix) ? __uv$config.decodeUrl(url.split(__uv$config.prefix)[1]) : url;
                if (tabEl) {
                    const img = tabEl.querySelector('img');
                    const icon = tabEl.querySelector('.tab-icon');
                    img.src = `https://www.google.com/s2/favicons?domain=${realUrl}&sz=64`;
                    img.style.display = 'block';
                    icon.style.display = 'none';
                }
            } catch(e){}

            frame.onload = () => {
                try {
                    const title = frame.contentDocument.title;
                    if (title && tabEl) {
                        tabEl.title = title;
                        tabEl.querySelector('.tab-title').textContent = title;
                    }
                    
                    const loc = frame.contentWindow.location.href;
                    if (loc && loc.includes(__uv$config.prefix)) {
                        cTab.url = loc;
                        updateUrlBar(loc);
                    }

                    const win = frame.contentWindow;
                    win.open = (u, t) => { window.newTab(u); return null; };
                    win.document.body.addEventListener('click', (e) => {
                        const link = e.target.closest('a');
                        if (link && link.target === '_blank') {
                            e.preventDefault();
                            window.newTab(link.href);
                        }
                    });
                } catch(e) {}
            };
        }

        document.getElementById("form").addEventListener("submit", (e) => {
            e.preventDefault();
            nav(document.getElementById("urlbar").value.trim());
        });

        function nav(val) {
             if (!val) return;
             let url = val;
             if (!url.startsWith('http') && !url.includes('.')) url = "https://duckduckgo.com/?q=" + encodeURIComponent(val);
             else if (!url.startsWith('http')) url = "https://" + url;
             navigateFrame(aTab, url);
        }

        newTab();
        window.nav = nav;
        window.addPin = addPin;
        window.removePin = removePin;

        function b() { document.querySelector(`.viewframe[data-frame-id="${aTab}"]`)?.contentWindow.history.back(); }
        function f() { document.querySelector(`.viewframe[data-frame-id="${aTab}"]`)?.contentWindow.history.forward(); }
        function r() { document.querySelector(`.viewframe[data-frame-id="${aTab}"]`)?.contentWindow.location.reload(); }
        function full() { 
             const frame = document.querySelector(`.viewframe[data-frame-id="${aTab}"]`);
             if (frame) {
                 const win = window.open("about:blank", "_blank");
                 if(win) {
                     win.document.body.style.margin = "0";
                     win.document.body.style.height = "100vh";
                     const iframe = win.document.createElement("iframe");
                     iframe.style.border = "none";
                     iframe.style.width = "100%";
                     iframe.style.height = "100%";
                     iframe.src = frame.src;
                     win.document.body.appendChild(iframe);
                 }
             }
        }

    </script>
</body>
</html>
